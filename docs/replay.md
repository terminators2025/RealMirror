# Replay Script - User Guide

## Overview

The `script/replay.py` tool allows you to replay and verify teleoperation demonstrations recorded in HDF5 format within Isaac Sim. This is essential for validating data quality before converting to training format or debugging data collection issues.

## Key Features

- **Visual Verification**: Replay demonstrations in Isaac Sim to verify robot motions and object interactions
- **Multi-Demo Support**: Navigate through multiple demonstrations within a single HDF5 file
- **Interactive Controls**: Play, pause, reset, and switch between demos using keyboard controls
- **State Restoration**: Accurately restore robot joint states and object poses to initial conditions
- **26-DOF to 38-DOF Expansion**: Automatically expand recorded 26-DOF actions to 38-DOF for simulation (including mimic joints)
- **Task-Driven Configuration**: Uses the same task configuration files as teleoperation for scene setup

## Basic Usage

```bash
$isaac_sim_dir/python.sh script/replay.py --task <task_name> --hdf5_path <path_to_hdf5_file>
```

### Command-Line Arguments

| Argument | Required | Description |
|----------|----------|-------------|
| `--task` | Yes | Task name matching the task configuration file (e.g., `Task1_Kitchen_Cleanup`) |
| `--hdf5_path` | Yes | Path to the HDF5 file containing recorded demonstrations |

## Usage Examples

### Example 1: Replay Task 1 Data

```bash
$isaac_sim_dir/python.sh script/replay.py \
    --task Task1_Kitchen_Cleanup \
    --hdf5_path /data/record/kitchen_demos.hdf5
```

### Example 2: Replay Task 2 Data

```bash
$isaac_sim_dir/python.sh script/replay.py \
    --task Task2_Cup_to_Cup_Transfer \
    --hdf5_path /data/record/cup_transfer_demos.hdf5
```

### Example 3: Replay Task 4 Data

```bash
$isaac_sim_dir/python.sh script/replay.py \
    --task Task4_Can_Stacking \
    --hdf5_path /data/record/can_stacking_demos.hdf5
```

## Interactive Controls

Once the replay script is running, use the following keyboard controls:

| Key | Function | Description |
|-----|----------|-------------|
| **S** | Play/Pause | Toggle playback of the current demonstration |
| **R** | Reset | Reset the current demo to its initial state |
| **N** | Next Demo | Load and display the next demonstration in the file |

### Control Workflow

1. **Start Replay**: The script automatically loads the first demo in the HDF5 file
2. **Press 'S'**: Begin playback of the demonstration
3. **Press 'S' again**: Pause playback at current frame
4. **Press 'R'**: Return to the beginning of current demo
5. **Press 'N'**: Skip to next demo and reset to its initial state

## Technical Details

### Data Structure Requirements

The replay script expects HDF5 files with the following structure (generated by `teleop.py`):

```
hdf5_file.h5
└── data/
    ├── demo_0/
    │   ├── actions                          # (N, 26) - robot actions
    │   ├── initial_state/
    │   │   ├── articulation/
    │   │   │   └── robot/
    │   │   │       └── joint_position       # (1, 26) - initial joint positions
    │   │   └── rigid_object/
    │   │       └── <object_name>/
    │   │           └── root_pose            # (1, 7) - [pos(3), quat_xyzw(4)]
    │   ├── states/
    │   │   └── articulation/
    │   │       └── robot/
    │   │           └── joint_position       # (N, 26) - joint positions per frame
    │   └── obs/
    │       ├── left_wrist_camera_bgr        # (N, H, W, 3) - camera images
    │       ├── right_wrist_camera_bgr       # (N, H, W, 3)
    │       └── head_camera_bgr              # (N, H, W, 3)
    ├── demo_1/
    │   └── ...
    └── demo_N/
        └── ...
```

### 26-DOF to 38-DOF Action Expansion

The replay script automatically expands recorded 26-DOF actions to 38-DOF for simulation:

**26-DOF Structure:**
- 14 arm joints (7 per arm)
- 12 hand master joints (6 per hand)

**38-DOF Structure:**
- 14 arm joints (unchanged)
- 24 hand joints (12 per hand, including mimic followers)

**Expansion Mapping:**

For each hand (left and right):

| Master Joint (26-DOF) | Follower Joints (38-DOF) | Mapping Rule |
|----------------------|--------------------------|--------------|
| thumb_swing (1 joint) | thumb_swing_joint (1 joint) | 1-to-1 |
| thumb_1 (1 joint) | thumb_1/2/3_joint (3 joints) | 1-to-3 (same value) |
| index_1 (1 joint) | index_1/2_joint (2 joints) | 1-to-2 (same value) |
| middle_1 (1 joint) | middle_1/2_joint (2 joints) | 1-to-2 (same value) |
| ring_1 (1 joint) | ring_1/2_joint (2 joints) | 1-to-2 (same value) |
| little_1 (1 joint) | little_1/2_joint (2 joints) | 1-to-2 (same value) |

### State Restoration

When loading a demo or pressing 'R' to reset, the script restores:

1. **Robot Joint State**:
   - Loads 26-DOF initial joint positions from `initial_state/articulation/robot/joint_position`
   - Expands to 38-DOF using mimic joint rules
   - Sets joint positions and zeros velocities

2. **Object Poses**:
   - For each tracked object in `initial_state/rigid_object/`
   - Restores position and orientation (quaternion converted from xyzw to wxyz)
   - Zeros linear and angular velocities

3. **Scene Stability**:
   - Executes 5 physics steps without rendering to stabilize the scene
   - Ensures all objects settle to their initial states

### Playback Synchronization

- **Recording Frequency**: 30 Hz (must match teleoperation recording frequency)
- **Playback Timing**: Wall-clock based synchronization
- **Frame Skipping**: Automatically skips frames if rendering falls behind real-time
- **Action Application**: Uses Isaac Sim's `ArticulationAction` with joint position control

## Workflow Integration

### Typical Data Validation Workflow

1. **Collect Data**: Use `teleop.py` to record demonstrations
   ```bash
   $isaac_sim_dir/python.sh script/teleop.py --task Task1_Kitchen_Cleanup --output-dir /data/record
   ```

2. **Verify Data**: Use `replay.py` to visually verify recordings
   ```bash
   $isaac_sim_dir/python.sh script/replay.py --task Task1_Kitchen_Cleanup --hdf5_path /data/record/recorded_data.hdf5
   ```

3. **Check Each Demo**:
   - Press 'S' to play
   - Observe robot motions are smooth and correct
   - Check object interactions match expectations
   - Press 'N' to verify next demo
   - Press 'R' if you need to re-watch

4. **Convert to Training Format**: If data looks good, proceed with conversion
   ```bash
   python3 script/convert.py /path/to/output --data_pairs data_pairs.json --arc2gear
   ```

## Troubleshooting

### Issue: Replay Script Fails to Start

**Symptoms:**
- Error: "Task config not found"
- Error: "HDF5 file not found"

**Solutions:**
1. Verify task name matches exactly: `Task1_Kitchen_Cleanup` (case-sensitive)
2. Check that task JSON exists in `tasks/` directory
3. Verify HDF5 file path is correct and file exists
4. Ensure you're running from the RealMirror root directory

### Issue: Robot Appears in Wrong Position

**Symptoms:**
- Robot starts in T-pose or unexpected configuration
- Robot joints are not at demonstration starting position

**Solutions:**
1. Verify HDF5 file contains `initial_state/articulation/robot/joint_position`
2. Check that joint position data has correct shape (26,)
3. Press 'R' to reset to initial state
4. Ensure robot configuration matches the one used during recording

### Issue: Objects Not Appearing or in Wrong Location

**Symptoms:**
- Tracked objects missing from scene
- Objects appear in different positions than recording

**Solutions:**
1. Verify HDF5 file contains `initial_state/rigid_object/<object_name>/root_pose`
2. Check task configuration has correct `task_related_objects`
3. Ensure object USD paths in task config are correct
4. Verify object names match between recording and task config

### Issue: Playback is Jerky or Skips Frames

**Symptoms:**
- Robot motion appears to jump or skip
- Playback is not smooth

**Solutions:**
1. Close unnecessary applications to free GPU resources
2. Reduce physics substeps in simulation config if needed
3. Check system meets hardware requirements (RTX 5090/5880)
4. This is normal behavior if rendering cannot keep up with 30 Hz playback

### Issue: Demo Doesn't Play When Pressing 'S'

**Symptoms:**
- Pressing 'S' has no effect
- No playback starts

**Solutions:**
1. Check console for error messages
2. Verify actions data loaded successfully (look for "Loaded N frames" message)
3. Ensure action data has correct shape (N, 26)
4. Try pressing 'R' to reset, then 'S' to play

### Issue: Replay Finishes Too Quickly or Too Slowly

**Symptoms:**
- Playback speed doesn't match recording speed

**Solutions:**
1. This should not happen - replay is synchronized to wall-clock time
2. If it does occur, verify `RECORDING_FREQUENCY = 30.0` matches teleoperation frequency
3. Check system time is synchronized correctly

## Advanced Usage

### Inspecting Demo Metadata

Before replaying, you can inspect HDF5 file metadata:

```python
import h5py

with h5py.File('/path/to/data.hdf5', 'r') as f:
    # List all demos
    demos = list(f['data'].keys())
    print(f"Total demos: {len(demos)}")
    
    # Check first demo shape
    demo0 = f['data']['demo_0']
    actions = demo0['actions']
    print(f"Demo 0 has {actions.shape[0]} frames")
    print(f"Action shape: {actions.shape}")
```

### Replaying Specific Demo

The script always starts with `demo_0`. To start from a different demo:
1. Start the replay script
2. Press 'N' repeatedly to navigate to desired demo
3. Press 'S' to begin playback

### Comparing Multiple HDF5 Files

To compare demonstrations from different recording sessions:
1. Replay first file: `script/replay.py --task Task1 --hdf5_path file1.hdf5`
2. Close replay (Ctrl+C)
3. Replay second file: `script/replay.py --task Task1 --hdf5_path file2.hdf5`
4. Compare robot behaviors visually

## Performance Considerations

### System Requirements
- **GPU**: NVIDIA RTX 5090/5880 (as per RealMirror requirements)
- **RAM**: 16GB+ recommended
- **Isaac Sim**: 5.0.0 with physics simulation enabled

### Optimization Tips
- **Headless Mode**: Not applicable for replay (requires visualization)
- **Recording Frequency**: 30 Hz is optimal for both recording and replay
- **Demo Length**: Shorter demos (< 1000 frames / ~33 seconds) load and reset faster
- **Number of Demos**: HDF5 files with 50-100 demos perform well

## Important Notes

### Data Consistency
- Replay uses the same task configuration as recording
- Ensure task JSON files are not modified between recording and replay
- Robot configuration must match the recording session

### Known Limitations
1. **Camera Images**: Not replayed (only actions and states)
2. **Force/Torque Data**: Not recorded in HDF5, cannot be replayed
3. **Contact Events**: Physics contacts may differ slightly from original recording
4. **Mimic Joint Behavior**: Replay uses simplified mimic rules (may differ from real robot)

### Best Practices
1. **Always verify data** before starting long training runs
2. **Check all demos** in a file, not just the first one
3. **Watch for collision artifacts** that might indicate bad data
4. **Verify object grasps** are successful and stable
5. **Note any anomalies** for potential data filtering

## Related Documentation

For related workflows and tools, see:
- Teleoperation: `docs/xr_linker_quik_start.md`
- Data Conversion: `docs/convert_script_usage.md`
- Training: `script/train.sh` and README section 2.6

## Additional Resources

For implementation details and source code, see:
- Replay script: `script/replay.py`
- Task configurations: `tasks/Task*.json`
- Robot configuration: `comm_config/configs/a2_robot_config.json`
- Scene manager: `simulation/scene_manager.py`

For questions or issues, please refer to the project repository or contact the development team.
